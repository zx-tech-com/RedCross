<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<!-- namespace指向mapper接口 -->
<mapper namespace="com.zx.redcross.dao.social.SocialMapper">
	<!--返回一个TopicType集合  -->
	<select id="findCustomer" resultType="Customer">
	 select id,nickname,avatar_url,detail_address,tel,is_visitor 
	 from customer where id=#{customerId}	
	</select>



	<!--返回一个TopicType集合  -->
	<select id="findAllTopicType" resultType="TopicType">
	 select id,tname,thumbnail_url from topic_type	
	</select>
	<!--返回一个int类型数据和  -->
	<select id="findAllTopicCount" resultType="int">
	 select count(id) from topic	
	</select>
	
	<!--查询所有发布帖子的信息，包括发帖人的信息 -->
	<select id="findAllTopic" resultMap="topic" >
	SELECT 
	topic.*,customer.id,customer.nickname,customer.avatar_url,
		(SELECT COUNT(id) FROM topic_coment WHERE topic_coment.topic_id=topic.`id`) AS totalComment,
		(SELECT COUNT(id) FROM topic_thumbsup WHERE topic_thumbsup.topic_id=topic.`id`) AS totalThumbsup
		<if test="customerId!=null">
		,(SELECT COUNT(id) FROM concerns WHERE  concerns.customer0_id = topic.customer_id AND concerns.`customer1_id` =#{customerId})AS flag
		</if>
		<if test="customerId == null" >
		,0 AS flag
		</if>
	FROM topic
	LEFT JOIN customer
	ON customer.`id`=topic.`customer_id`
	<where>
		<if test="topicTypeId!=null">
		topic.type_id=#{topicTypeId}
		</if>
	</where>
	ORDER BY topic.`id` DESC LIMIT #{page.start},#{page.pageSize}
	</select>
	
	
	<!--点击帖子缩略图获取一则帖子的全部信息包括发帖人信息  -->
	<select id="findTopicById" resultMap="topic">
	select topic.*,customer.id,customer.nickname,customer.avatar_url,
	(SELECT COUNT(id) FROM topic_coment WHERE topic_coment.topic_id=topic.`id`) AS totalComment,
		(SELECT COUNT(id) FROM topic_thumbsup WHERE topic_thumbsup.topic_id=topic.`id`) AS totalThumbsup
	<if test="customerId!=null" >
		,(SELECT COUNT(id) FROM concerns WHERE  concerns.customer0_id = topic.customer_id AND concerns.`customer1_id` =#{customerId})AS flag
	</if>
	<if test="customerId == null" >
		,0 AS flag
	</if>
	  FROM topic
 	LEFT JOIN customer
	ON customer.`id`=topic.`customer_id`	where	topic.id=#{topicId}
	</select>
	
	
	
	<select id="findTopicCustomerId"  resultType="int">
	select count(id)  from concerns	where customer1_id=#{aCustomerId} and customer0_id={pCustomerId}
	</select>
	
	<insert id="saveConcert">
	INSERT INTO concerns(customer1_id,customer0_id)  VALUES(#{aCustomerId},#{pCustomerId});
	</insert>
	<delete id="deleteConcert">
	DELETE FROM concerns WHERE customer1_id=#{aCustomerId} AND customer0_id=#{pCustomerId};
	</delete>	
	<!--获取一级评论的全部信息  -->
	<select id="findTopicComent" resultMap="topicComent">
	SELECT topic_coment.*,customer.id,customer.nickname,customer.avatar_url
		,(SELECT COUNT(coment_thumbsup_id) FROM coment_thumbsup WHERE coment_thumbsup.`topic_coment_id`=topic_coment.id) AS totalThumbsup
		<if test="customerId!=null" >
		,(SELECT COUNT(coment_thumbsup_id) FROM coment_thumbsup WHERE coment_thumbsup.`topic_coment_id`=topic_coment.id AND coment_thumbsup.`customer_id`=#{customerId}) AS totalThumbsNum
		</if>
		<if test="customerId==null">
		,0 AS totalThumbsNum
		</if>
		FROM 
		topic_coment LEFT JOIN  customer
		ON topic_coment.`customer_id`=customer.`id`
	WHERE topic_coment.is_topcoment=1 AND  topic_coment.topic_id=#{topicId}  LIMIT #{page.start},#{page.pageSize}
	</select> 
	
	<!--获取二级评论的全部信息  -->
	<select id="findTopicComent2" resultMap="topicComent">
	SELECT topic_coment.*,customer.id,customer.nickname,customer.avatar_url 
		,(SELECT COUNT(coment_thumbsup_id) FROM coment_thumbsup WHERE coment_thumbsup.`topic_coment_id`=topic_coment.id) AS totalThumbsup
		<if test="customerId!=null" >
		,(SELECT COUNT(coment_thumbsup_id) FROM coment_thumbsup WHERE coment_thumbsup.`topic_coment_id`=topic_coment.id AND coment_thumbsup.`customer_id`=#{customerId}) AS totalThumbsNum
		</if>
		<if test="customerId==null">
		,0 AS totalThumbsNum
		</if>
		FROM 
		topic_coment LEFT JOIN  customer
		ON topic_coment.`customer_id`=customer.`id`
	WHERE  topic_coment.`topcoment_id`=#{topicComentId} AND topic_coment.`coment_id` IS NULL  LIMIT #{page.start},#{page.pageSize}
	</select>
	
	<!--获取三级评论的全部信息  -->
	<select id="findTopicComent3" resultMap="topicComent2">
	SELECT a.*,c1.`id` AS a_customer_id,c1.`nickname`,c1.avatar_url
	,b.id AS b_id,b.`content` AS b_content,c2.nickname AS b_nickname
	,(SELECT COUNT(coment_thumbsup_id) FROM coment_thumbsup WHERE coment_thumbsup.`topic_coment_id`=a.id) AS totalThumbsup
		<if test="customerId!=null" >
		,(SELECT COUNT(coment_thumbsup_id) FROM coment_thumbsup WHERE coment_thumbsup.`topic_coment_id`=topic_coment.id AND coment_thumbsup.`customer_id`=#{customerId}) AS totalThumbsNum
		</if>
		<if test="customerId==null">
		,0 AS totalThumbsNum
		</if>
	FROM topic_coment a
	LEFT JOIN  customer c1
	ON a.`customer_id`=c1.`id`
	LEFT JOIN topic_coment b ON b.`id`=a.`coment_id`
	LEFT JOIN customer c2 ON c2.`id`=b.`customer_id` 
	 WHERE a.`coment_id` IS NOT NULL AND a.`is_topcoment`=0 AND a.`coment_id`=#{topicComentId} LIMIT #{page.start},#{page.pageSize}
	</select>
	
	<!--插入评论  -->
	<insert id="saveTopicComent">
	INSERT INTO topic_coment(topic_id,customer_id,content,is_topcoment,coment_id,topcoment_id) 
	VALUES(#{topicId},#{customerId},#{content},#{isTopcoment},#{comentId},#{topcomentId}); 
	</insert>
	
	<!-- 查询用户是否点过赞 -->
	<select id="findThunsup" resultType="int">
		select count(coment_thumbsup_id) from	coment_thumbsup
		where topic_coment_id=#{topicComentId} and customer_id=#{coustomerId}
	</select>
	
	<!--插入评论点赞  -->
	<insert id="saveThunsup" >
		insert into  coment_thumbsup(topic_coment_id,customer_id)  VALUES(#{topicComentId},#{coustomerId})
	</insert>
	
	<!--删除评论点赞  -->
	<delete id="deleteThunsup">
	delete from	coment_thumbsup 
	where topic_coment_id=#{topicComentId} and customer_id=#{coustomerId}
	</delete>
	
	<!-- 查询用户是否点过赞 -->
	<select id="findTopicThunsup" resultType="int">
		select count(id) from	topic_thumbsup
		where topic_id=#{topicId} and customer_id=#{coustomerId}
	</select>
	
	<!--插入评论点赞  -->
	<insert id="saveTopicThunsup" >
		insert into  topic_thumbsup(topic_id,customer_id)  VALUES(#{topicId},#{coustomerId})
	</insert>
	
	<!--删除评论点赞  -->
	<delete id="deleteTopicThunsup">
	delete from	topic_thumbsup
	where topic_id=#{topicId} and customer_id=#{coustomerId}
	</delete>
	
	<!--发布帖子  -->
	<insert id="saveTopic" parameterType="topic">
	 insert into topic(customer_id,type_id,title,content,has_video,video_url,img_url)
	values(#{customerId},#{typeId},#{title},#{content},#{hasVideo},#{videoUrl},#{imagUrl})	
	</insert>
	
	
	<!-- 关联映射 结果查询 -->
	<!--会员  -->
	<resultMap type="Customer" id="CustomerMap">
		 <id property= "id" column="id"/>
         <result property= "nickname" column="nickname"/>
         <result property= "avatarUrl" column= "avatar_url"/>
	</resultMap> 
	
	<!--帖子  -->
	<resultMap type="Topic" id="topic">
		 <id property= "id" column="id"/>
         <result property= "title" column= "topic_id"/>
         <result property= "content" column= "customer_id"/>
         <result property= "publishTime" column= "publish_time"  />
         <result property= "hasVideo" column="has_video"/>
		 <result property= "videoUrl" column="video_url" />
		 <result property= "totalThumbsup" column="totalThumbsup"/>
		 <result property= "totalComment" column="totalComment" />
		 <result property= "flag" column="flag" />
		<association property="customer" javaType="Customer" autoMapping="true">		
			<id column="customer_id" property="id"/>
		</association>	
	</resultMap>
	
 	<!--帖子评论表  -->
	<resultMap type="TopicComent" id="topicComent">
		 <id property= "id" column="id"/>
         <result property= "comentId" column= "coment_id"/>
         <result property= "content" column= "content"/>
         <result property= "topcomentId" column= "topcoment_id"  />
         <result property= "content" column="content"/>
		 <result property= "comentTime" column="coment_time" />
		 <result property= "isTopcoment" column="is_topcoment"/>
		<association property="customer" javaType="Customer" autoMapping="true">		
			<id column="customer_id" property="id"/>
		</association>		
	</resultMap>
	
	
	<!--帖子评论表    a 回复 b -->
	<resultMap type="TopicComent" id="topicComent2" autoMapping="true">
		<id property= "id" column="id"/><!-- a -->
		<association property="customer" javaType="Customer" autoMapping="true">		
			<id column="a_customer_id" property="id"/>
		</association>		
        <association property="topicComent2" javaType="TopicComent" autoMapping="true" columnPrefix="b_">
        	<id column="b_id" property= "id" /><!-- b -->
        	<association property="customer" javaType="Customer" autoMapping="true" >		
				<id column="b_customer_id" property="id"/>
			</association>
        </association>
	</resultMap> 
	
	
</mapper>