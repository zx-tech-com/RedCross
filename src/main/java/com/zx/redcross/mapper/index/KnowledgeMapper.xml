<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.zx.redcross.dao.index.IKnowledgeMapper">
	
	<resultMap type="Knowledge" id="simpleKnowledge">
		<id column="id" property="id"/>
		<result column="content" property="content"/>
		<result column="title" property="title"/>
		<association property="knowledgeType" autoMapping="true" javaType="com.zx.redcross.entity.KnowledgeType">
			<id column="type_id" property="id"/>
		</association>
	</resultMap>
	
	<select id="listKnowledgeByType" resultType="Knowledge">
		SELECT 
			knowledge.id,content,title,type_id,kname
		FROM knowledge
		LEFT JOIN knowledge_type ON knowledge.type_id = knowledge_type.id	
		<where>
			<if test="typeId != null">
				type_id = #{typeId}
			</if>
		</where>
		LIMIT ${page.start},${page.pageSize};
	</select>
	
	<select id="getKnowledgeById" resultType="Knowledge">
		SELECT 
			knowledge.id,content,title,type_id,kname
		FROM knowledge
		LEFT JOIN knowledge_type ON knowledge.type_id = knowledge_type.id
		WHERE knowledge.id = #{id};
	</select>
	
	<insert id="saveKnowledge" useGeneratedKeys="true" keyColumn="id">
		INSERT INTO 
			knowledge ( type_id, title, content, has_video, video_url )
		VALUES
			(#{Knowledge.knowledgeType.id},#{Knowledge.title},
			#{Knowledge.content},#{Knowledge.has_video},#{Knowledge.video_url});
	</insert>
	
	
	<select id="listKnowledgeType" resultMap="knowledgeType">
		SELECT 
			id,kname,description
		FROM knowledge_type;
	</select>
	
	<!-- 后台添加知识类型 -->
	<insert id="adminSaveKnowledgeType" parameterType="knowledgeType">
	INSERT INTO knowledge_type(kname,description) VALUE(#{kname},#{description})
	</insert>
	
	<!-- 后台删除知识类型 -->
	<delete id="adminDeleteKnowledgeType" parameterType="int">
	DELETE FROM knowledge_type WHERE id=#{knowledgeTypeId}
	</delete>
	
	<!-- 后台修改知识类型 -->
	<update id="adminUpdateKnowledgeType" parameterType="int">
	UPDATE knowledge_type SET kname=#{kname},description=#{description} WHERE id=#{id}
	</update>
	
	<!-- 后台删除知识 -->
	<delete id="adminDeleteKnowledge" parameterType="int">
	DELETE FROM knowledge WHERE id=#{knowledgeId}
	</delete>
	
	<!-- 后台修改知识类型 -->
	<update id="adminUpdateKnowledge" >
	UPDATE knowledge SET 
	type_id=#{Knowledge.knowledgeType.id},
	title=#{Knowledge.title},
	content=#{Knowledge.content},
	has_video=#{Knowledge.has_video},
	video_url=#{Knowledge.video_url}
	WHERE id=#{Knowledge.id}
	</update>
	<!--查询所有付费视频 -->
	<select id="listVideo" resultMap="videoMap">
	SELECT v.id,v.vindex,v.vname,v.description,v.video_url,v.price
	vb.`id` AS video_buy_record_id,
	vb.`status` 
	FROM video v
	LEFT JOIN  video_buy_record vb
	ON v.`id`=vb.`video_id` AND customer_id=#{customerId}
 	ORDER BY v.id DESC
	</select>
	
	
	
	
	
	
	<resultMap type="Video" id="videoMap" autoMapping="true">
		 <id property= "id" column="id"/>
		<association property="videoBuyRecord" javaType="VideoBuyRecord" autoMapping="true">		
			<id column="video_buy_record_id" property="id"/>
		</association>		
	</resultMap>
	
	
	
	
	
	<!--查询一个付费视频 -->
	<select id="getVideo" resultMap="videoMap">
	SELECT v.id,v.vindex,v.vname,v.description,v.video_url,
	vb.`id` AS video_buy_record_id,
	vb.`status` 
	FROM video v
	LEFT JOIN  video_buy_record vb
	ON v.`id`=vb.`video_id` AND vb.customer_id=#{customerId}
 	where v.id=#{videoId}
	</select>
	
	
	
	<!--会员点击支付后会生成一条正在记录  -->
	<insert id="saveVideoBuyRecord">
	INSERT INTO video_buy_record(video_id,customer_id,order_number,coment,STATUS) 
	VALUES(#{videoBuyRecord.video.id},
	#{videoBuyRecord.customer.id},
	#{videoBuyRecord.orderNumber},
	#{videoBuyRecord.coment},
	#{videoBuyRecord.status})
	</insert>
	
	
	<!-- 会员点击支付成功后会生成一条支付成功记录 -->
	<update id="uptateVideoBuyRecord" parameterType="int">
		update video_buy_record set status=2 where id=#{videoBuyRecordId}
	</update>
	
	
	
	
	
	<resultMap type="KnowledgeType" id="knowledgeType" autoMapping="false">
		<id column="id" property="id"/>
		<result column="kname" property="kname"/>
		<result column="description" property="description"/>
	</resultMap>
	
</mapper>